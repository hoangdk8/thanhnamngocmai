"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[283],{3104:(t,e,r)=>{r.d(e,{EU:()=>s,M9:()=>u,XB:()=>o,ZH:()=>c,mY:()=>n});var i=r(31335),a=r(49509);a.env.NEXT_PUBLIC_UMAMI_WEBSITE_ID,a.env.NEXT_PUBLIC_UMAMI_URL;let n=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"magic_link";(0,i.u4)("signup",{method:t})},o=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"magic_link";(0,i.u4)("login",{method:t})},s=()=>{(0,i.u4)("template_viewed")},c=t=>{(0,i.u4)("invitation_published",{invitation_id:t})},u=t=>{(0,i.u4)("invitation_deleted",{was_published:t})}},4106:(t,e,r)=>{r.d(e,{o:()=>i});let i={track:(t,e)=>{if(window.ttq)try{window.ttq.track(t,e)}catch(t){console.error("TikTok Pixel tracking error:",t)}},trackCompleteRegistration:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;i.track("CompleteRegistration",{contents:[{content_id:"wedding_invitation_user",content_type:"product_group",content_name:"Wedding Invitation Registration"}],value:t,currency:"VND"})},trackStartTrial:(t,e)=>{i.track("StartTrial",{contents:[{content_id:t,content_type:"product",content_name:e?"Template ".concat(e):"Wedding Invitation"}],value:2e4,currency:"VND"})},trackPurchase:(t,e,r)=>{i.track("Purchase",{contents:[{content_id:e,content_type:"product",content_name:"Wedding Invitation Premium",content_category:"wedding_services"}],value:t,currency:"VND",description:r?"Discount: ".concat(r):void 0})},trackPlaceAnOrder:(t,e)=>{i.track("PlaceAnOrder",{contents:[{content_id:t,content_type:"product",content_name:e?"Template ".concat(e):"Wedding Invitation"}],value:2e4,currency:"VND"})},trackSubscribe:t=>{i.track("Subscribe",{contents:[{content_id:"newsletter_subscription",content_type:"product_group",content_name:"ChungDoi Updates"}],value:0,currency:"VND",description:t||"User subscribed to updates"})}}},23843:(t,e,r)=>{r.d(e,{$:()=>i});let i={get apiUrl(){return function(){let t="https://api.chungdoi.com";{let e=window.location.hostname;if("chungdoi.com"===e||"www.chungdoi.com"===e)return t;if(e.includes("ngrok")||/^(192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.|10\.)/.test(e))return"/backend-api"}return t}()},baseUrl:"https://chungdoi.com",googleMapsApiKey:"AIzaSyAY8WQxGig6axA_jZil94btO9G6dhsFEKg",gaId:"G-L3F7LGNEH1",nodeEnv:"production",isDevelopment:!1,isProduction:!0};i.isDevelopment},31335:(t,e,r)=>{r.d(e,{Fi:()=>l,MO:()=>d,c5:()=>n,do:()=>m,f0:()=>u,u4:()=>o,uN:()=>h});var i=r(72341);let a={};function n(t){a={...a,...t}}function o(t,e){let r={...a,...e};window.umami&&window.umami.track(t,r),window.gtag&&s&&window.gtag("event",t,r);try{i.Ay.capture(t,r)}catch(t){}}let s="G-L3F7LGNEH1",c=()=>!!(s&&window.gtag),u=(t,e)=>{o(t,e)},l=t=>{var e,r;c()&&(null==(e=(r=window).gtag)||e.call(r,"set","user_properties",t))},m=t=>{var e,r;c()&&(null==(e=(r=window).gtag)||e.call(r,"config",s,{user_id:null!=t?t:void 0}))},h=t=>{let e="string"==typeof t?new Date(t):t;return Math.ceil(Math.abs(new Date().getTime()-e.getTime())/864e5)},d=t=>"happy"===t.toLowerCase()?99:199},40283:(t,e,r)=>{r.d(e,{A:()=>g,AuthProvider:()=>d});var i=r(95155),a=r(12115),n=r(79323),o=r(31335),s=r(3104),c=r(90506),u=r(4106);async function l(t){if(!t)return;let e=(0,c.sH)(),r=t.referral_code;if(r)return void(0,c.ME)(r);if(e&&!r)try{await n.u.saveReferralCode(e)}catch(t){console.error("Failed to sync referral code to DB:",t)}}function m(t){if(null==t?void 0:t.utm_source)return void(0,o.c5)({utm_source:t.utm_source,utm_medium:t.utm_medium,utm_campaign:t.utm_campaign});let e=n.u.getUTMParams(),r={};e.utm_source&&(r.utm_source=e.utm_source),e.utm_medium&&(r.utm_medium=e.utm_medium),e.utm_campaign&&(r.utm_campaign=e.utm_campaign),Object.keys(r).length>0&&(0,o.c5)(r)}let h=(0,a.createContext)(void 0);function d(t){let{children:e}=t,[r,c]=(0,a.useState)(null),[d,g]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(async()=>{try{m(null);let t=n.u.getUser();if(t&&n.u.isAuthenticated()){c(t);try{let t=await n.u.getCurrentUser();c(t),m(t)}catch(t){console.error("Token expired:",t),n.u.removeToken(),c(null)}}}catch(t){console.error("Failed to initialize auth:",t),n.u.removeToken(),c(null)}finally{g(!1)}})()},[]);let _=async t=>{try{let e=await n.u.login(t);e.user&&c(e.user)}catch(t){throw t}},p=async t=>{try{var e;await n.u.requestMagicLink(t);let r=(null==(e=t.email)?void 0:e.split("@")[1])||"unknown";(0,o.f0)("magic_link_requested",{email_domain:r})}catch(t){throw t}},f=async t=>{try{let e=await n.u.verifyMagicLink(t);c(e.user),e.isNewUser?((0,o.f0)("signup",{method:"magic_link"}),(0,s.mY)("magic_link"),u.o.trackCompleteRegistration()):((0,o.f0)("login",{method:"magic_link"}),(0,s.XB)("magic_link")),e.user&&((0,o.do)(e.user.id),(0,o.Fi)({user_role:e.user.role,user_type:"registered",email_verified:e.user.email_verified||!1,has_phone_number:!!e.user.phone_number}),m(e.user),l(e.user))}catch(t){throw t}},w=async t=>{try{let e=await n.u.verifyOTPCode(t);c(e.user);let r=e.isNewUser||!1;r?((0,o.f0)("signup",{method:"otp"}),(0,s.mY)("magic_link"),u.o.trackCompleteRegistration()):((0,o.f0)("login",{method:"otp"}),(0,s.XB)("magic_link")),(0,o.f0)("otp_verified",{method:"otp",is_new_user:r}),e.user&&((0,o.do)(e.user.id),(0,o.Fi)({user_role:e.user.role,user_type:"registered",email_verified:e.user.email_verified||!1,has_phone_number:!!e.user.phone_number}),m(e.user),l(e.user))}catch(t){throw t}},T=async t=>{try{await n.u.signup(t)}catch(t){throw t}},v=async()=>{try{(0,o.f0)("logout"),await n.u.logout(),c(null),(0,o.do)(null),(0,o.Fi)({user_type:"anonymous"})}catch(t){console.error("Logout failed:",t),c(null),(0,o.do)(null)}},y=t=>{if(r){let e={...r,...t};c(e),n.u.setUser(e)}},k=async()=>{try{let t=await n.u.getCurrentUser();return c(t),t}catch(t){return console.error("Failed to refresh user:",t),null}},E=async t=>{try{let e=await n.u.devLogin(t);c(e.user),(0,o.f0)("login",{method:"dev_login"}),(0,s.XB)("magic_link"),e.user&&((0,o.do)(e.user.id),(0,o.Fi)({user_role:e.user.role,user_type:"registered",email_verified:e.user.email_verified||!1,has_phone_number:!!e.user.phone_number}),m(e.user),l(e.user))}catch(t){throw t}},U=(0,a.useMemo)(()=>({user:r,loading:d,login:_,requestMagicLink:p,verifyMagicLink:f,verifyOTPCode:w,signup:T,logout:v,isAuthenticated:!!r,updateUser:y,refreshUser:k,devLogin:E}),[r,d]);return(0,i.jsx)(h.Provider,{value:U,children:e})}function g(){let t=(0,a.useContext)(h);if(void 0===t)throw Error("useAuth must be used within an AuthProvider");return t}},79323:(t,e,r)=>{r.d(e,{u:()=>n});var i=r(23843);let a=()=>i.$.apiUrl;class n{static validateUTMParam(t,e){if(!t)return;let r=t.trim();return r.length>e&&(console.warn("UTM parameter truncated from ".concat(r.length," to ").concat(e," characters")),r=r.substring(0,e)),(r=r.replace(/[<>'"]/g,""))||void 0}static getUTMParams(){let t=localStorage.getItem(this.UTM_KEY);if(t)try{let e=JSON.parse(t);if(e.timestamp&&Date.now()-e.timestamp<7776e6)return e.data;localStorage.removeItem(this.UTM_KEY)}catch(t){localStorage.removeItem(this.UTM_KEY)}let e=new URLSearchParams(window.location.search),r={},i=this.validateUTMParam(e.get("utm_source"),this.UTM_MAX_LENGTHS.utm_source),a=this.validateUTMParam(e.get("utm_medium"),this.UTM_MAX_LENGTHS.utm_medium),n=this.validateUTMParam(e.get("utm_campaign"),this.UTM_MAX_LENGTHS.utm_campaign),o=this.validateUTMParam(e.get("utm_content"),this.UTM_MAX_LENGTHS.utm_content),s=this.validateUTMParam(e.get("utm_term"),this.UTM_MAX_LENGTHS.utm_term);i&&(r.utm_source=i),a&&(r.utm_medium=a),n&&(r.utm_campaign=n),o&&(r.utm_content=o),s&&(r.utm_term=s);let c=this.validateUTMParam(e.get("fbclid"),this.UTM_MAX_LENGTHS.fbclid),u=this.validateUTMParam(e.get("gclid"),this.UTM_MAX_LENGTHS.gclid),l=this.validateUTMParam(e.get("ttclid"),this.UTM_MAX_LENGTHS.ttclid);if(c&&(r.fbclid=c),u&&(r.gclid=u),l&&(r.ttclid=l),!r.utm_source&&!r.fbclid&&!r.gclid&&!r.ttclid&&document.referrer){let t=this.validateUTMParam(document.referrer,this.UTM_MAX_LENGTHS.referrer);t&&(r.referrer=t)}return Object.keys(r).length>0&&localStorage.setItem(this.UTM_KEY,JSON.stringify({data:r,timestamp:Date.now()})),r}static clearUTMParams(){localStorage.removeItem(this.UTM_KEY)}static getToken(){let t=localStorage.getItem("impersonation_token");return t||localStorage.getItem(this.TOKEN_KEY)}static setToken(t){localStorage.setItem(this.TOKEN_KEY,t)}static removeToken(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)}static getUser(){let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}static setUser(t){localStorage.setItem(this.USER_KEY,JSON.stringify(t))}static isAuthenticated(){return!!this.getToken()}static async login(t){return this.requestMagicLink({email:t.email})}static async requestMagicLink(t){let e=this.getUTMParams(),r={...t,...e},i=await fetch("".concat(a(),"/api/auth/request-magic-link"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok)throw Error((await i.json()).error||"Kh\xf4ng thể gửi email. Vui l\xf2ng thử lại.");return{message:(await i.json()).message,user:null,token:""}}static async verifyMagicLink(t){let e=await fetch("".concat(a(),"/api/auth/verify-magic-link"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(!e.ok)throw Error((await e.json()).error||"Link kh\xf4ng hợp lệ hoặc đ\xe3 hết hạn.");let r=await e.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async verifyOTPCode(t){let e=await fetch("".concat(a(),"/api/auth/verify-code"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error((await e.json()).error||"M\xe3 kh\xf4ng hợp lệ hoặc đ\xe3 hết hạn.");let r=await e.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async signup(t){let e=this.getUTMParams(),r=await fetch("".concat(a(),"/api/auth/signup"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t.name,email:t.email,...e})});if(!r.ok)throw Error((await r.json()).error||"Đăng k\xfd thất bại. Vui l\xf2ng thử lại sau.");let i=await r.json();return{message:i.message,user:i.user||null,token:""}}static async logout(){let t=this.getToken();if(t)try{await fetch("".concat(a(),"/api/auth/logout"),{method:"POST",headers:{Authorization:"Bearer ".concat(t)}})}catch(t){console.error("Logout API call failed:",t)}this.removeToken()}static async getCurrentUser(){let t=this.getToken();if(!t)throw Error("Chưa đăng nhập. Vui l\xf2ng đăng nhập để tiếp tục.");let e=await fetch("".concat(a(),"/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t)}});if(!e.ok){if(401===e.status)throw this.removeToken(),Error("Ph\xean đăng nhập đ\xe3 hết hạn. Vui l\xf2ng đăng nhập lại.");throw Error("Kh\xf4ng thể tải th\xf4ng tin t\xe0i khoản. Vui l\xf2ng thử lại.")}let r=await e.json();return r.user&&this.setUser(r.user),r.user}static async authenticatedFetch(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getToken();if(!r)throw Error("Chưa đăng nhập. Vui l\xf2ng đăng nhập để tiếp tục.");let i={...e.headers,Authorization:"Bearer ".concat(r)},a=await fetch(t,{...e,headers:i});if(401===a.status)throw this.removeToken(),Error("Authentication expired");return a}static async devLogin(t){let e=await fetch("".concat(a(),"/api/auth/dev-login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(!e.ok)throw Error((await e.json()).error||"Dev login failed");let r=await e.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async getDevLoginUsers(t){let e=new URL("".concat(a(),"/api/auth/dev-login/users"));t&&t.length>=2&&e.searchParams.set("search",t);let r=await fetch(e.toString(),{method:"GET"});if(!r.ok)throw Error((await r.json()).error||"Failed to fetch users");return(await r.json()).users}static async saveReferralCode(t){let e=this.getToken();if(!e)throw Error("Chưa đăng nhập");let r=await fetch("".concat(a(),"/api/auth/referral-code"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({referral_code:t})});if(!r.ok)throw Error((await r.json()).error||"Kh\xf4ng thể lưu m\xe3 giảm gi\xe1");return r.json()}static isAdmin(t){return(null==t?void 0:t.role)==="admin"||(null==t?void 0:t.role)==="super_admin"}static isSuperAdmin(t){return(null==t?void 0:t.role)==="super_admin"}static hasAdminAccess(t){return this.isAdmin(t)}}n.TOKEN_KEY="auth_token",n.USER_KEY="auth_user",n.UTM_KEY="utm_params",n.UTM_MAX_LENGTHS={utm_source:100,utm_medium:100,utm_campaign:255,utm_content:255,utm_term:255,referrer:500,fbclid:255,gclid:255,ttclid:255}},90506:(t,e,r)=>{r.d(e,{$g:()=>s,ME:()=>c,T_:()=>o,YL:()=>a,iB:()=>i,sH:()=>u});let i=[{tier:1,name:"Bronze",minReferrals:0,maxReferrals:4,commissionPercent:10},{tier:2,name:"Silver",minReferrals:5,maxReferrals:14,commissionPercent:20},{tier:3,name:"Gold",minReferrals:15,maxReferrals:1/0,commissionPercent:30}],a=20,n={STORAGE_KEY:"chungdoi_ref"};function o(t){var e;let r=(e=t,i.find(t=>e>=t.minReferrals&&e<=t.maxReferrals)||i[0]),a=i.find(t=>t.tier===r.tier+1);return a?a.minReferrals-t:null}function s(t){return t.toLocaleString("vi-VN")}function c(t){localStorage.setItem(n.STORAGE_KEY,t.toUpperCase())}function u(){return localStorage.getItem(n.STORAGE_KEY)}}}]);